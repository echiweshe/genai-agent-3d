# Claude Integration for GenAI Agent 3D

This comprehensive guide provides information about Claude API integration in the GenAI Agent 3D project.

## Table of Contents

1. [Overview](#overview)
2. [Installation](#installation)
3. [Fixing the Claude API Integration](#fixing-the-claude-api-integration)
4. [Testing the Claude API](#testing-the-claude-api)
5. [Usage](#usage)
6. [Available Models](#available-models)
7. [API Usage and Costs](#api-usage-and-costs)
8. [Troubleshooting](#troubleshooting)
9. [Scripts Reference](#scripts-reference)

## Overview

GenAI Agent 3D now integrates with Anthropic's Claude AI models, providing enhanced capabilities for generating 3D content, diagrams, and more. Claude offers superior performance in understanding complex instructions and generating high-quality content, particularly for SVG generation and technical diagrams.

## Installation

To use Claude with GenAI Agent 3D, you need an Anthropic API key.

1. Visit the [Anthropic Console](https://console.anthropic.com/)
2. Create an account or sign in
3. Navigate to the API Keys section
4. Create a new API key (it will start with `sk-ant-`)
5. Add the key to your project using the scripts provided

## Fixing the Claude API Integration

The Claude API integration can be fixed and tested using the provided scripts.

### Using the Fix Script

```bash
python fix_claude_integration.py
```

This script:
1. Updates the `_generate_anthropic` method in the LLM service with the correct API headers and response parsing logic
2. Ensures the API key environment variable is properly configured
3. Updates the enhanced environment loader to support Anthropic

### What was Fixed

The following issues with the Claude API integration have been addressed:

1. **API Header Format**: Updated the header to use `X-API-Key` (with capital 'X') rather than `x-api-key` for proper authentication.
2. **Response Parsing**: Fixed the parsing of Claude's response format to correctly extract text content.
3. **API Version**: Ensured the correct `anthropic-version` header is included in requests.
4. **Environment Variable Loading**: Enhanced the environment variable loader to correctly handle the Anthropic API key.

## Testing the Claude API

After applying the fixes, you can test if the Claude API integration is working:

```bash
python test_claude_api.py
```

This script tests the connection to the Claude API by sending a simple request and verifying the response.

To check if the code integration is correct without making external API calls:

```bash
python check_claude_integration.py
```

This script examines the code structure to ensure all the necessary components are properly implemented.

## Usage

### Setting Claude as Default

To set Claude as the default LLM provider for all operations in GenAI Agent 3D:

```bash
python set_claude_default.py
```

This script updates both the `.env` file and `config.yaml` with Claude settings.

### Restarting Services with Claude

To restart all services with Claude as the default provider:

```bash
python restart_claude.py
```

This script sets Claude as the default provider and restarts all necessary services.

### Manual Configuration

You can also manually configure Claude by editing:

1. `genai_agent_project/.env`:
   ```
   LLM_PROVIDER=anthropic
   LLM_MODEL=claude-3-sonnet-20240229
   LLM_TYPE=cloud
   ```

2. `genai_agent_project/config.yaml` (if it exists):
   ```yaml
   llm:
     provider: anthropic
     model: claude-3-sonnet-20240229
     type: cloud
   ```

## Available Models

The following Claude models are available for use:

| Model ID | Name | Best For |
|----------|------|----------|
| claude-3-opus-20240229 | Claude 3 Opus | Most capable model, complex tasks |
| claude-3-sonnet-20240229 | Claude 3 Sonnet | Balanced performance and speed |
| claude-3-haiku-20240307 | Claude 3 Haiku | Fastest response time |
| claude-3.5-sonnet-20250626 | Claude 3.5 Sonnet | Latest model with improved capabilities |

## API Usage and Costs

Using Claude models via the Anthropic API incurs costs based on your usage:

- **Input Tokens**: Charged per 1,000 tokens sent to the API
- **Output Tokens**: Charged per 1,000 tokens generated by the model

The current approximate costs per 1,000 tokens are:
- Claude 3 Opus: $0.03 input / $0.15 output
- Claude 3 Sonnet: $0.003 input / $0.015 output
- Claude 3 Haiku: $0.00025 input / $0.00125 output
- Claude 3.5 Sonnet: $0.005 input / $0.025 output

Monitor your usage through the [Anthropic Console](https://console.anthropic.com/) to avoid unexpected charges.

## Troubleshooting

If you experience issues with the Claude API integration:

### API Key Issues

- Ensure your API key starts with `sk-ant-`
- Check that the API key is correctly set in the `.env` file
- Verify the API key is being properly loaded with `check_claude_integration.py`

### Connection Issues

- Check your internet connection
- Verify that your system can reach `api.anthropic.com`
- Look for proxy or firewall settings that might block the connection

### Response Parsing Errors

- Check the logs for detailed error messages
- Ensure the LLM service is correctly parsing Claude's response format
- Run `fix_claude_integration.py` to update the response parsing logic

### Model Selection Issues

- Verify that you're using a supported model ID (e.g., `claude-3-sonnet-20240229`)
- Check if the model is included in the provider discovery process

## Scripts Reference

| Script | Description |
|--------|-------------|
| `fix_claude_integration.py` | Fixes all issues with the Claude API integration |
| `test_claude_api.py` | Tests the connection to the Claude API |
| `check_claude_integration.py` | Checks if the code integration is correct |
| `set_claude_default.py` | Sets Claude as the default LLM provider |
| `restart_claude.py` | Restarts services with Claude as the default |
| `cleanup_claude_integration.py` | Organizes Claude integration scripts and documentation |

## Technical Details

### Claude API Headers

The correct headers for the Claude API are:

```python
headers = {
    "Content-Type": "application/json",
    "X-API-Key": api_key,  # Note the capital 'X'
    "anthropic-version": "2023-06-01"
}
```

### Claude Response Format

Claude's Messages API returns responses in the following format:

```json
{
  "id": "msg_abc123",
  "type": "message",
  "role": "assistant",
  "content": [
    {
      "type": "text",
      "text": "Hello! How can I help you today?"
    }
  ],
  "model": "claude-3-sonnet-20240229",
  "stop_reason": "end_turn",
  "usage": {
    "input_tokens": 10,
    "output_tokens": 9
  }
}
```

The content is an array of content blocks, each with a type. For text responses, we need to extract the text from blocks with `type: "text"`.
